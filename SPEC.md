# otd-convert-rs

A cross-platform Rust port of the OTDConverter for converting OTD (Optimized Tool Data) files to CNI (CNC ISO) format for Intermac glass cutting machines.

## Overview

This tool converts glass cutting optimization layouts from OTD format (generated by XCAWCUT and similar optimization software) into CNI files containing G-code instructions for Intermac Genius CNC glass cutting tables.

### Goals

- **100% compatible CNI output** - Generated files must work identically to the original C# OTDConverter
- **Cross-platform** - Native binaries for Windows and Linux
- **Comprehensive validation** - Meaningful error messages with specific error codes
- **Standalone operation** - No external database or DLL dependencies

### Scope

This implementation focuses on:
- **Machine types 100-199** (standard glass cutting tables)
- **Core G-code generation** (no DXF preview embedding)
- **Single file conversion** (no batch processing)
- **Hardcoded tool defaults** (no database lookups)

---

## File Formats

### OTD Input Format

OTD (Optimized Tool Data) files are INI-style text files generated by glass cutting optimization software. Two variants exist:

| Extension | Description |
|-----------|-------------|
| `.otd` | Plain text format |
| `.otx` | RC2-encrypted format |

#### OTD Sections

##### [Header]
File metadata and unit system.

```ini
[Header]
AWCutVersion=1.01.00
OptimizationRun=1
Dimension=inch          ; mm | inch | Tinch
Date=2024/07/30, 11:37:59
```

##### [Signature]
Creator software identification.

```ini
[Signature]
Creator=XCAWCUT Rel. 1.40, (c) 1995-2011 Albat + Wirsam
```

##### [Pattern]
Cutting layout definition. Multiple patterns per file (one per glass sheet). Uses hierarchical indentation (X→Y→Z→W→V→A→B→C→D→E) to define piece placement:

```ini
[Pattern]
GlassID=126
GlassDescription=3mm 1/8"
GlassThickness=0.125984
Width=129.500000
Height=95.500000
TrimLeft=0.500000
TrimBottom=0.500000
X=129.000000
  Y=26.312500
    Z=25.125000 Shape=1 Info=1
    Z=25.125000 Shape=1 Info=1
  Y=22.875000
    Z=11.437500
      W=19.937500 Shape=2 Info=2
```

Key fields:
- `GlassID` - Material type identifier
- `GlassThickness` - Material thickness in current unit system
- `Width`, `Height` - Sheet dimensions
- `TrimLeft`, `TrimBottom` - Edge trim allowances
- `X/Y/Z/W/V...` - Nested coordinate hierarchy for piece placement
- `Shape=N` - Reference to shape definition
- `Info=N` - Reference to piece/order information

##### [Shape]
Custom shape/contour definitions for non-rectangular pieces.

```ini
[Shape]
Id=1
Description=Form50 (Rotated)
x=0.000000 y=25.813000 X=20.563000 Y=25.813000
x=20.563000 y=25.813000 X=24.625000 Y=21.750000 R=4.062000
x=24.625000 y=21.750000 X=24.625000 Y=4.563000
x=24.625000 y=4.563000 X=20.563000 Y=0.500000 R=4.063000
x=20.563000 y=0.500000 X=0.000000 Y=0.500000
```

Geometry line format:
- `x=`, `y=` - Start point (lowercase)
- `X=`, `Y=` - End point (uppercase)
- `R=radius` - Clockwise arc
- `L=radius` - Counter-clockwise arc
- `C=toolcode` - Tool code for this segment

Shape types by description:
- `Form50` - 3-edge shape (one straight edge, corners rounded)
- `Form51` - 4-edge shape (all corners rounded)
- `Form99` - Complex curved shape with chamfers
- `(Rotated)` suffix - 90-degree rotated orientation

##### [Info]
Piece metadata for customer/order tracking.

```ini
[Info]
Id=1
OrderNo=709838
PosNo=0
Customer=LIPPERT COMPONENTS  30-Jul
Commission=P2028 3EDGE
SecondGlassReference=1559 1/8" GL-20
RackNo=5
SheetWidth=26.312500
SheetHeight=25.125000
SheetCode=5
```

##### [Cuttings]
Detailed cut specifications (alternative to nested Pattern coordinates). Used for pre-optimized cut data.

```ini
[Cuttings]
x=0.5 y=0.0 X=0.5 Y=95.5 Levcut=1 Rot=90 Qcut=129.0 Lcut=95.5 Tcut=15 Rcut=0.5
XO=0.5 YO=0.5 Width=25.125 Height=26.3125 Info=1 Shape=1 IndPiece=1
IndPiece=1 Cut=1
```

Cut line fields:
- `x`, `y`, `X`, `Y` - Start and end coordinates
- `Levcut` - Cut level (hierarchy depth)
- `Rot` - Tool rotation angle
- `Qcut` - Cut quota (position in hierarchy)
- `Lcut` - Cut length
- `Tcut` - Cut type flags (bitmask)
- `Rcut` - Rest/remainder dimension

Piece line fields (XO=):
- `XO`, `YO` - Origin coordinates
- `Width`, `Height` - Piece dimensions
- `Info`, `Shape` - References to Info/Shape sections
- `IndPiece` - Piece index

##### [LowE]
Low-E coating ablation paths (laser removal before cutting). Same format as Cuttings.

#### OTX Encryption

OTX files use RC2 encryption:
- **Password**: `%x$Intermac^(zx`
- **Key derivation**: CryptDeriveKey("RC2", "MD5", 128-bit)
- **IV**: `[68, 101, 67, 97, 114, 110, 101, 68]` = "DeCarneD" in ASCII

---

### CNI Output Format

CNI files contain G-code instructions for Intermac CNC machines, organized into sections.

#### Section Structure

```
[COMMENTO]        ; Comments and metadata
[CENTRO01]        ; Work center (empty)
[PARAMETRI01]     ; Machine parameters
[UTENSILI01]      ; Tool list
[LAVORAZIONI01]   ; Operations (empty)
[CONTORNATURA01]  ; Main G-code program
[*LDIST####_01]   ; Distribution list (piece info)
```

#### [COMMENTO]
Comments preceded by semicolons:

```
[COMMENTO]
; Project: cod1.otd
; Material : 126
; Creator: OTDConverter
; Version: 1.3.1.19
```

#### [PARAMETRI01]
Machine setup parameters:

```
[PARAMETRI01]
N10 G70 LX=129.5 LY=95.5 LZ=0.125984 P103=130
%
```

- `G70` - Inch mode
- `G71` - Metric mode
- `LX`, `LY` - Sheet dimensions
- `LZ` - Material thickness
- `P103` - Machine type parameter

#### [UTENSILI01]
Tool codes (4-digit, one per line):

```
[UTENSILI01]
0003
0031
%
```

Common tools:
- `0003` - Linear scoring wheel
- `0031` - Shaped cutting tool

#### [CONTORNATURA01]
Main G-code program with:

##### Line Numbering
All lines prefixed with `N####` (incrementing by 10):
```
N20 P015=1
N30 L=PRGINIT
N40 JM:(P262)
```

##### Pattern Labels
Each pattern/sheet has a label:
```
:0001
:0002
:0003
```

##### Tool Selection
```
N150 P007=0003    ; Set tool number
N160 L=PTOOL      ; Load tool macro
```

##### Linear Cuts (G00/G01)
```
N200 G00 X=0.5 Y=0.039 C=P540     ; Rapid move
N210 M=533                         ; Direction code
N220 L=PT_GIU                      ; Tool down
N230 G01 X=0.5 Y=95.46 C=P540     ; Linear cut
N240 L=PT_SU                       ; Tool up
```

##### Rotation Control
```
N180 P539=90        ; Set rotation angle
N190 L=PROT_B       ; Apply rotation
```

##### Shape Cuts (G02/G03)
```
N8390 G28                              ; Enable tangent mode
N8400 G01 X=0 Y=25.813                 ; Line segment
N8410 G02 X=24.625 Y=21.75 I=20.563 J=21.751  ; Clockwise arc
N8450 G01 G46                          ; Cancel tangent mode
```

- `G02` - Clockwise arc (I, J = arc center)
- `G03` - Counter-clockwise arc
- `G28` - Tangent cutting mode
- `G46` - Cancel tangent mode

##### Shape Macros
Shapes are defined as reusable macros:
```
:1010001001              ; Macro label
N8310 L=PT_SU
N8320 P539=0.001
...
%                        ; End macro
```

Called via:
```
N2410 G58
N2420 XO=0.5             ; X offset
N2430 YO=0.5             ; Y offset
N2440 L:1010001001       ; Call macro
```

##### Jump Commands
```
N120 JM((P260=2)~(P007=0003)):010001   ; Conditional jump
N140 JM(P260=2):999999999              ; End jump
N3390 JM:999999999                     ; Unconditional jump
```

##### Program End
```
:999999999
N10730 L=PFOXOUT
%
```

#### [*LDIST####_01]
Distribution list with piece information (comments):

```
[*LDIST0001_01]
;Cod=cod11
;DimX=129.5
;DimY=95.5
;Spes=0.125984
;Qta=1
;TipoVetro=126
;NomeSagoma=
;CodPz=5
;DimXPz=25.125
;DimYPz=26.3125
;QtaPz=5
;ClientePz=LIPPERT COMPONENTS  30-Jul
;OrdinePz=709838
```

---

## Data Model

### Schema
Complete cutting layout for one glass sheet.

| Field | Type | Description |
|-------|------|-------------|
| `otd_version` | String | OTD file version |
| `unit` | Unit | mm, inch, or Tinch |
| `date` | String | Creation date |
| `creator` | String | Software that created the file |
| `machine_name` | String | Target machine name |
| `machine_number` | u16 | Machine type (100-199) |
| `glass_id` | String | Material identifier |
| `glass_description` | String | Material description |
| `thickness` | f64 | Glass thickness |
| `glass_structured` | bool | Textured glass flag |
| `glass_coated` | bool | Low-E coated glass flag |
| `width` | f64 | Sheet width |
| `height` | f64 | Sheet height |
| `trim_left` | f64 | Left edge trim |
| `trim_bottom` | f64 | Bottom edge trim |
| `quantity` | u32 | Number of sheets |
| `cutting_order` | u8 | 0=linear first, 1=shapes first |
| `linear_advance` | f64 | Tool advance offset |
| `min_angle` | f64 | Minimum cutting angle |
| `linear_cuts` | Vec\<Cut\> | Linear cut segments |
| `pieces` | Vec\<Piece\> | Workpieces |
| `piece_types` | Vec\<PieceType\> | Piece metadata |
| `shapes` | Vec\<Shape\> | Shape definitions |

### Cut (Taglio)
Individual cut segment.

| Field | Type | Description |
|-------|------|-------------|
| `cut_type` | CutType | Line, ArcCW, ArcCCW |
| `line_type` | LineType | Vertical, Horizontal, Oblique |
| `xi`, `yi` | f64 | Start point |
| `xf`, `yf` | f64 | End point |
| `xc`, `yc` | f64 | Arc center (if arc) |
| `radius` | f64 | Arc radius |
| `level` | i32 | Cut hierarchy level |
| `rotation` | f64 | Tool rotation angle |
| `quota` | f64 | Position quota |
| `length` | f64 | Cut length |
| `cut_type_lam` | u8 | Cut type flags |
| `rest` | f64 | Remainder dimension |
| `piece_indices` | Vec\<i32\> | Affected piece indices |
| `active` | bool | Whether cut is active |

### Piece (Pezzo)
Workpiece definition.

| Field | Type | Description |
|-------|------|-------------|
| `x_origin` | f64 | X position on sheet |
| `y_origin` | f64 | Y position on sheet |
| `width` | f64 | Piece width |
| `height` | f64 | Piece height |
| `info_id` | Option\<i32\> | Reference to Info section |
| `shape_id` | Option\<i32\> | Reference to Shape section |
| `piece_index` | i32 | Unique piece index |
| `piece_type_index` | Option\<usize\> | Index into piece_types |
| `shape_index` | Option\<usize\> | Index into shapes |

### Shape (Sagoma)
Custom shape/contour.

| Field | Type | Description |
|-------|------|-------------|
| `id` | i32 | Shape identifier |
| `name` | String | Shape name |
| `description` | String | Shape description (Form50, etc.) |
| `rotation` | f64 | Base rotation (ROTS) |
| `left_border` | f64 | Left border offset |
| `cuts` | Vec\<Cut\> | Shape segments |
| `tool_types` | Vec\<bool\> | Tools needed for this shape |

### PieceType (TipoPezzo)
Customer/order metadata.

| Field | Type | Description |
|-------|------|-------------|
| `id` | i32 | Type identifier |
| `order_no` | String | Order number |
| `position_no` | String | Position number |
| `customer` | String | Customer name |
| `commission` | String | Commission reference |
| `second_glass_ref` | String | Secondary glass reference |
| `rack_no` | String | Rack/sort number |
| `sheet_width` | f64 | Nominal piece width |
| `sheet_height` | f64 | Nominal piece height |
| `piece_code` | i32 | Piece code identifier |
| `waste` | bool | Waste/scrap flag |

---

## Transformation Pipeline

### 1. Linear Cut Processing

#### Merge Overlapping Cuts (`unisci_tagli_lineari`)
Combines adjacent or overlapping cuts on the same line into single cuts.

#### Remove Edge Cuts (`elimina_tagli_lineari_vuoti`)
Removes cuts that are too close to sheet boundaries (within `d_min_bordo` threshold).

#### Optimize Cut Order (`ordina_tagli_lineari`)
Reorders cuts to minimize tool travel distance using nearest-neighbor heuristic.

#### Apply Linear Advance (`applica_anticipo_tagli_lineari`)
Extends cut start/end points by the linear advance amount.

### 2. Shape Processing

#### Remove Overlapping Shape Segments (`elimina_tagli_sagoma`)
Removes shape segments that overlap with linear cuts (already cut by linear pass).

#### Tool Type Detection (`cerca_tipi_utensile`)
Identifies which tool types are needed for each shape based on segment codes.

### 3. Piece Processing

#### Index Assignment (`set_indici_pezzi`)
Assigns piece type and shape indices to each piece.

#### Side Detection (`set_lati_pezzo`)
Determines which sides of each piece touch the sheet boundaries.

#### Shape Validation (`chk_sagome_in_pezzi`)
Validates that the same shape isn't used on pieces of different sizes.

---

## Validation & Error Codes

### Error Categories

| Code | Category | Description |
|------|----------|-------------|
| -1 | File | File not found |
| -2 | File | Empty file |
| -3 | Parse | General parse error |
| -11 | Structure | No [Pattern] section found |
| E100 | Geometry | Invalid arc geometry |
| E101 | Geometry | Coordinates out of bounds |
| E200 | Validation | Shape used on different-sized pieces |
| E201 | Validation | No cuts found in layout |
| E202 | Validation | Tool not found for thickness |

### Validation Stages

1. **File Validation**
   - File exists and readable
   - Extension is .otd or .otx
   - OTX decryption successful (if applicable)

2. **Structural Validation**
   - At least one [Pattern] section exists
   - Key-value pairs parse correctly
   - Numeric values are valid

3. **Semantic Validation**
   - Sheet dimensions are positive
   - Pieces fit within sheet
   - Shape references exist
   - Info references exist

4. **Geometric Validation**
   - Arc radii are valid for endpoints
   - Shape contours close properly
   - Coordinates within bounds

5. **Business Rules**
   - Same shape not used on different-sized pieces
   - Minimum piece sizes respected

---

## Configuration

### Hardcoded Tool Defaults

| Tool Code | Purpose |
|-----------|---------|
| 0003 | Linear scoring wheel |
| 0031 | Shaped cutting tool |

### Machine Constants

| Parameter | Value | Description |
|-----------|-------|-------------|
| `Eps` | 0.0001 | Floating-point comparison epsilon |
| `d_min_bordo` | 2.0 | Minimum distance from sheet edge |
| `d_min_cont` | 0.0001 | Minimum distance for continuous path |

### Unit Conversions

| Unit | Multiplier to mm |
|------|-----------------|
| mm | 1.0 |
| inch | 25.4 |
| Tinch | 30.303 |

---

## CLI Interface

```
otd-convert-rs

Convert OTD files to CNI format for Intermac glass cutting machines.

USAGE:
    otd-convert [OPTIONS] --input <INPUT> --output <OUTPUT>

OPTIONS:
    -i, --input <INPUT>      Input OTD/OTX file path
    -o, --output <OUTPUT>    Output CNI file path
    -m, --machine <MACHINE>  Machine number [default: 130]
        --validate           Validate only, don't generate output
        --debug              Output debug information
    -v, --verbose            Verbose output
    -h, --help               Print help
    -V, --version            Print version

EXAMPLES:
    # Basic conversion
    otd-convert -i layout.otd -o layout.cni

    # With machine number
    otd-convert -i layout.otd -o layout.cni -m 130

    # Validation only
    otd-convert -i layout.otd --validate
```

---

## Testing Strategy

### Test Data

Reference files from `/WNC/USER/ISO/Intermac_Genius/9-5-25-Backup/`:
- Multiple OTD/CNI pairs with varying complexity
- Different shape types (Form50, Form51, Form99)
- Multiple patterns per file
- Different unit systems

### Test Categories

1. **Parser Tests**
   - Each section type parses correctly
   - OTX decryption works
   - Error cases handled

2. **Transform Tests**
   - Cut merging produces correct results
   - Ordering minimizes travel
   - Shape segment removal correct

3. **Generator Tests**
   - G-code syntax correct
   - Line numbering correct
   - Tool codes correct

4. **Integration Tests**
   - Full pipeline produces matching output
   - Compare against reference CNI files
   - Floating-point tolerance for coordinates

### Validation Criteria

Output CNI files must match reference files:
- Same section structure
- Same G-code commands (within tolerance)
- Same line number increments
- Same tool sequences
- Same distribution list content

---

## Project Structure

```
otd-convert-rs/
├── Cargo.toml
├── SPEC.md                  # This file
├── README.md                # User documentation
├── src/
│   ├── main.rs              # CLI entry point
│   ├── lib.rs               # Library exports
│   ├── error.rs             # Error types
│   ├── config.rs            # Configuration
│   ├── parser/
│   │   ├── mod.rs
│   │   ├── otd.rs           # OTD parser
│   │   └── sections.rs      # Section parsers
│   ├── model/
│   │   ├── mod.rs
│   │   ├── schema.rs
│   │   ├── cut.rs
│   │   ├── piece.rs
│   │   ├── shape.rs
│   │   └── piece_type.rs
│   ├── transform/
│   │   ├── mod.rs
│   │   ├── linear.rs
│   │   └── shapes.rs
│   ├── generator/
│   │   ├── mod.rs
│   │   ├── cni.rs
│   │   └── gcode.rs
│   └── validation/
│       ├── mod.rs
│       └── validate.rs
└── tests/
    ├── fixtures/            # Sample OTD/CNI files
    ├── parser_tests.rs
    └── integration_tests.rs
```

---

## References

### Original Implementation
- C# OTDConverter library (decompiled from OTDConverter.dll v1.3.1.19)
- Located at: `/home/damon/Work/te/Intermac/OTDConverter/`

### Sample Data
- OTD/CNI file pairs at: `/home/damon/Work/te/Intermac/WNC/USER/ISO/Intermac_Genius/9-5-25-Backup/`

### G-code Reference
- ISO 6983 (G-code standard)
- Intermac Genius machine documentation

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 0.1.0 | TBD | Initial release |
